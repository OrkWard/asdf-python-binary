#!/usr/bin/env bash

set -euo pipefail

source "$(dirname "$0")/utils.sh"

list_all() {
  local target archive releases release assets_json
  target=$(detect_target_triple)
  archive=$(archive_flavor)
  releases=$(release_tags_to_search | sed '/^$/d' | uniq)

  if [ -z "$releases" ]; then
    echoerr "No release tags to search."
    exit 1
  fi

  local versions=""
  while read -r release; do
    assets_json=$(release_assets_json "$release")
    versions+=$'\n'"$(extract_versions_for_target "$assets_json" "$target" "$archive")"
  done <<<"$releases"

  # Get unique full versions and also generate simple versions
  local full_versions simple_versions
  full_versions=$(echo "$versions" | sed '/^$/d' | sort -V | uniq)
  
  # Extract simple versions (major.minor) from full versions
  simple_versions=$(echo "$full_versions" | while read -r version; do
    if [[ "$version" =~ ^([0-9]+\.[0-9]+)\. ]]; then
      echo "${BASH_REMATCH[1]}"
    fi
  done | sort -V | uniq)

  # Combine both full versions and simple versions
  {
    echo "$full_versions"
    echo "$simple_versions"
  } | sed '/^$/d' | sort -V | uniq
}

list_all
